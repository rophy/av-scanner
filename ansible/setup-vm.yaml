---
# setup-vm.yaml - Set up ClamAV and dependencies on the AV Scanner VM
#
# This playbook is used by scripts/vm-init.sh to configure the VM after creation.
# It works with both Multipass and QEMU VMs.
#
# Usage:
#   # For Multipass VM:
#   ansible-playbook setup-vm.yaml -i inventory.yaml
#
#   # For QEMU VM (with password auth):
#   ansible-playbook setup-vm.yaml \
#     -e ansible_host=localhost \
#     -e ansible_port=2222 \
#     -e ansible_user=ubuntu \
#     -e ansible_password=ubuntu \
#     -e ansible_ssh_common_args='-o StrictHostKeyChecking=no'

- name: Set up AV Scanner VM
  hosts: "{{ target_host | default('av-scanner') }}"
  become: true
  gather_facts: true

  vars:
    # SSH connection settings (can be overridden via -e)
    ansible_port: "{{ target_port | default(22) }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

    # ClamAV configuration
    scan_dir: /tmp/av-scanner
    clamav_log_dir: /var/log/clamav

  tasks:
    # ============================================
    # System Update
    # ============================================
    - name: Wait for cloud-init to complete
      command: cloud-init status --wait
      changed_when: false
      failed_when: false
      timeout: 300

    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    # ============================================
    # ClamAV Installation
    # ============================================
    - name: Install ClamAV and dependencies
      apt:
        name:
          - clamav
          - clamav-daemon
          - clamav-freshclam
          - moreutils
          - python3
          - python3-apt
        state: present

    # ============================================
    # Scan Directory Setup
    # ============================================
    - name: Create scan directory
      file:
        path: "{{ scan_dir }}"
        state: directory
        mode: "0777"

    - name: Mount tmpfs for scan directory (enables fanotify)
      mount:
        path: "{{ scan_dir }}"
        src: tmpfs
        fstype: tmpfs
        opts: size=512M,mode=0777
        state: mounted

    # ============================================
    # ClamAV Database Update
    # ============================================
    - name: Stop freshclam service temporarily
      systemd:
        name: clamav-freshclam
        state: stopped
      failed_when: false

    - name: Update ClamAV database (this may take a while)
      command: freshclam
      register: freshclam_result
      changed_when: "'Database updated' in freshclam_result.stdout or 'is up-to-date' not in freshclam_result.stdout"
      failed_when: false
      timeout: 600

    - name: Start freshclam service
      systemd:
        name: clamav-freshclam
        state: started
        enabled: true

    # ============================================
    # ClamAV Daemon Configuration
    # ============================================
    - name: Wait for ClamAV database files
      wait_for:
        path: "/var/lib/clamav/{{ item }}"
        state: present
        timeout: 600
      loop:
        - daily.cvd
        - main.cvd
      failed_when: false

    - name: Ensure ClamAV daemon is enabled and started
      systemd:
        name: clamav-daemon
        state: started
        enabled: true
      register: clamav_daemon_start
      retries: 5
      delay: 10
      until: clamav_daemon_start is succeeded

    # ============================================
    # ClamAV On-Access Scanning (clamonacc)
    # ============================================
    - name: Configure ClamAV on-access scanning
      blockinfile:
        path: /etc/clamav/clamd.conf
        marker: "# {mark} ANSIBLE MANAGED - On-Access Scanning"
        block: |
          OnAccessMountPath {{ scan_dir }}
          OnAccessExcludeUname clamav
          OnAccessPrevention yes
          LogTime yes
      notify: Restart ClamAV daemon

    - name: Create clamonacc systemd service
      copy:
        content: |
          [Unit]
          Description=ClamAV On-Access Scanner
          Requires=clamav-daemon.service
          After=clamav-daemon.service

          [Service]
          Type=simple
          User=root
          ExecStart=/usr/sbin/clamonacc --foreground --log={{ clamav_log_dir }}/clamonacc.log --move={{ scan_dir }}/quarantine
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/clamav-clamonacc.service
        mode: "0644"
      notify: Restart clamonacc

    - name: Create quarantine directory
      file:
        path: "{{ scan_dir }}/quarantine"
        state: directory
        mode: "0700"
        owner: root
        group: root

    - name: Ensure clamonacc log file exists
      file:
        path: "{{ clamav_log_dir }}/clamonacc.log"
        state: touch
        owner: clamav
        group: clamav
        mode: "0644"
      changed_when: false

    - name: Enable and start clamonacc
      systemd:
        name: clamav-clamonacc
        state: started
        enabled: true
        daemon_reload: true
      failed_when: false

    # ============================================
    # Verification
    # ============================================
    - name: Test ClamAV with EICAR
      block:
        - name: Create EICAR test file
          copy:
            content: "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
            dest: /tmp/eicar-test.com
            mode: "0644"

        - name: Scan EICAR test file
          command: clamdscan /tmp/eicar-test.com
          register: eicar_scan
          failed_when: false
          changed_when: false

        - name: Verify EICAR detection
          assert:
            that:
              - "'FOUND' in eicar_scan.stdout or eicar_scan.rc == 1"
            fail_msg: "ClamAV did not detect EICAR test file"
            success_msg: "ClamAV successfully detected EICAR test file"

        - name: Remove EICAR test file
          file:
            path: /tmp/eicar-test.com
            state: absent
      rescue:
        - name: EICAR test failed (non-fatal)
          debug:
            msg: "EICAR detection test failed, but continuing. ClamAV may still be loading databases."

    - name: Display ClamAV status
      command: systemctl status clamav-daemon --no-pager
      register: clamav_status
      changed_when: false
      failed_when: false

    - name: Show ClamAV status
      debug:
        msg: "{{ clamav_status.stdout_lines }}"

  handlers:
    - name: Restart ClamAV daemon
      systemd:
        name: clamav-daemon
        state: restarted
        daemon_reload: true

    - name: Restart clamonacc
      systemd:
        name: clamav-clamonacc
        state: restarted
        daemon_reload: true
