---
# deploy.yaml - Deploy AV Scanner binary to VM
#
# Prerequisites:
#   - Run 'make setup-vm' first to install ClamAV
#
# Usage:
#   make deploy
#
- name: Deploy AV Scanner to VM
  hosts: av-scanner
  become: true
  vars:
    app_dir: /home/ubuntu/av-scanner
    av_engine: clamav  # Options: clamav, trendmicro, mock
    image_name: av-scanner
    image_tag: latest
    image_file: "{{ playbook_dir }}/../av-scanner-image.tar"
    scan_dir: /tmp/av-scanner
    clamav_log_dir: /var/log/clamav

  tasks:
    # ============================================
    # Prerequisites Check
    # ============================================
    - name: Check if ClamAV is installed
      command: which clamdscan
      register: clamav_check
      changed_when: false
      failed_when: false

    - name: Warn if ClamAV not installed
      debug:
        msg: "WARNING: ClamAV not found. Run 'make setup-vm' first for full functionality."
      when: clamav_check.rc != 0

    # ============================================
    # Podman Installation (for extracting binary)
    # ============================================
    - name: Install Podman
      apt:
        name:
          - podman
        state: present
        update_cache: true

    # ============================================
    # Binary Extraction from Docker Image
    # ============================================
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Copy container image to VM
      copy:
        src: "{{ image_file }}"
        dest: "{{ app_dir }}/av-scanner-image.tar"
        owner: ubuntu
        group: ubuntu
        mode: "0644"

    - name: Load container image
      command: podman load -i {{ app_dir }}/av-scanner-image.tar
      register: podman_load
      changed_when: "'Loaded image' in podman_load.stdout"

    - name: Create temporary container to extract binary
      command: podman create --name av-scanner-extract {{ image_name }}:{{ image_tag }}
      register: container_create
      changed_when: true
      failed_when: false

    - name: Extract binary from container
      command: podman cp av-scanner-extract:/av-scanner /usr/local/bin/av-scanner
      notify: Restart av-scanner

    - name: Remove temporary container
      command: podman rm av-scanner-extract
      failed_when: false

    - name: Set binary permissions
      file:
        path: /usr/local/bin/av-scanner
        mode: "0755"
        owner: root
        group: root

    # ============================================
    # Systemd Service Configuration
    # ============================================
    - name: Create av-scanner systemd service
      copy:
        content: |
          [Unit]
          Description=AV Scanner Service
          After=network.target clamav-daemon.service clamav-clamonacc.service

          [Service]
          Type=simple
          User=root
          Environment=PORT=3000
          Environment=AV_ENGINE={{ av_engine }}
          Environment=UPLOAD_DIR=/tmp/av-scanner
          Environment=CLAMAV_RTS_LOG_PATH=/var/log/clamav/clamonacc.log
          Environment=TM_RTS_LOG_PATH=/var/log/ds_agent/ds_agent.log
          Environment=LOG_LEVEL=info
          ExecStart=/usr/local/bin/av-scanner
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/av-scanner.service
        mode: "0644"
      notify: Restart av-scanner

    - name: Enable and start av-scanner service
      systemd:
        name: av-scanner
        state: started
        enabled: true
        daemon_reload: true

    # ============================================
    # Verification
    # ============================================
    - name: Wait for service to be ready
      uri:
        url: "http://localhost:3000/api/v1/health"
        method: GET
        status_code: [200, 503]
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display service status
      debug:
        msg: "AV Scanner is running at http://{{ ansible_host }}:3000"

  handlers:
    - name: Restart av-scanner
      systemd:
        name: av-scanner
        state: restarted
        daemon_reload: true
