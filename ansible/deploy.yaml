---
- name: Deploy AV Scanner to VM
  hosts: av-scanner
  become: true
  vars:
    app_dir: /home/ubuntu/av-scanner
    av_engine: clamav
    image_name: av-scanner
    image_tag: latest
    image_file: "{{ playbook_dir }}/../av-scanner-image.tar"

  tasks:
    # ============================================
    # Podman Installation (for extracting binary)
    # ============================================
    - name: Install Podman
      apt:
        name:
          - podman
        state: present
        update_cache: true

    # ============================================
    # ClamAV Installation
    # ============================================
    - name: Install ClamAV and dependencies
      apt:
        name:
          - clamav
          - clamav-daemon
          - moreutils
        state: present

    - name: Create scan directory for on-access monitoring
      file:
        path: /tmp/av-scanner
        state: directory
        mode: "0777"

    - name: Mount tmpfs for scan directory (enables fanotify)
      mount:
        path: /tmp/av-scanner
        src: tmpfs
        fstype: tmpfs
        opts: size=512M,mode=0777
        state: mounted

    - name: Ensure freshclam is running
      systemd:
        name: clamav-freshclam
        state: started
        enabled: true

    - name: Ensure ClamAV daemon is running
      systemd:
        name: clamav-daemon
        state: started
        enabled: true

    - name: Configure ClamAV on-access scanning
      blockinfile:
        path: /etc/clamav/clamd.conf
        marker: "# {mark} ANSIBLE MANAGED - On-Access Scanning"
        block: |
          OnAccessMountPath /tmp/av-scanner
          OnAccessExcludeUname clamav
          OnAccessPrevention yes
          LogTime yes
      notify: Restart ClamAV services

    - name: Create clamonacc systemd service
      copy:
        content: |
          [Unit]
          Description=ClamAV On-Access Scanner
          Requires=clamav-daemon.service
          After=clamav-daemon.service

          [Service]
          Type=simple
          User=root
          ExecStart=/usr/sbin/clamonacc --foreground --log=/var/log/clamav/clamonacc.log --remove
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/clamav-clamonacc.service
        mode: "0644"
      notify: Restart ClamAV services

    - name: Ensure clamonacc log file exists
      file:
        path: /var/log/clamav/clamonacc.log
        state: touch
        owner: clamav
        group: clamav
        mode: "0644"

    - name: Enable and start clamonacc
      systemd:
        name: clamav-clamonacc
        state: started
        enabled: true
        daemon_reload: true

    # ============================================
    # Binary Extraction from Docker Image
    # ============================================
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Copy container image to VM
      copy:
        src: "{{ image_file }}"
        dest: "{{ app_dir }}/av-scanner-image.tar"
        owner: ubuntu
        group: ubuntu
        mode: "0644"

    - name: Load container image
      command: podman load -i {{ app_dir }}/av-scanner-image.tar
      register: podman_load
      changed_when: "'Loaded image' in podman_load.stdout"

    - name: Create temporary container to extract binary
      command: podman create --name av-scanner-extract {{ image_name }}:{{ image_tag }}
      register: container_create
      changed_when: true
      failed_when: false

    - name: Extract binary from container
      command: podman cp av-scanner-extract:/av-scanner /usr/local/bin/av-scanner
      notify: Restart av-scanner

    - name: Remove temporary container
      command: podman rm av-scanner-extract
      failed_when: false

    - name: Set binary permissions
      file:
        path: /usr/local/bin/av-scanner
        mode: "0755"
        owner: root
        group: root

    # ============================================
    # Systemd Service Configuration
    # ============================================
    - name: Create av-scanner systemd service
      copy:
        content: |
          [Unit]
          Description=AV Scanner Service
          After=network.target clamav-daemon.service clamav-clamonacc.service

          [Service]
          Type=simple
          User=root
          Environment=PORT=3000
          Environment=AV_ENGINE={{ av_engine }}
          Environment=UPLOAD_DIR=/tmp/av-scanner
          Environment=CLAMAV_RTS_LOG_PATH=/var/log/clamav/clamonacc.log
          Environment=TM_RTS_LOG_PATH=/var/log/ds_agent/ds_agent.log
          Environment=LOG_LEVEL=info
          ExecStart=/usr/local/bin/av-scanner
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/av-scanner.service
        mode: "0644"
      notify: Restart av-scanner

    - name: Enable and start av-scanner service
      systemd:
        name: av-scanner
        state: started
        enabled: true
        daemon_reload: true

    # ============================================
    # Verification
    # ============================================
    - name: Wait for service to be ready
      uri:
        url: "http://localhost:3000/api/v1/health"
        method: GET
        status_code: [200, 503]
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display service status
      debug:
        msg: "AV Scanner is running at http://{{ ansible_host }}:3000"

  handlers:
    - name: Restart ClamAV services
      systemd:
        name: "{{ item }}"
        state: restarted
        daemon_reload: true
      loop:
        - clamav-daemon
        - clamav-clamonacc

    - name: Restart av-scanner
      systemd:
        name: av-scanner
        state: restarted
        daemon_reload: true
