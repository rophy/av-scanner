---
# deploy.yaml - Deploy AV Scanner binary to VM
#
# Prerequisites:
#   - Run 'make setup-vm' first to install ClamAV and registry
#
# Usage:
#   make deploy
#
- name: Deploy AV Scanner to VM
  hosts: av-scanner
  become: true
  vars:
    av_engine: clamav  # Options: clamav, trendmicro, mock
    image_name: av-scanner
    image_tag: latest
    registry: localhost:5000
    scan_dir: /tmp/av-scanner
    clamav_log_dir: /var/log/clamav

  tasks:
    # ============================================
    # Prerequisites Check
    # ============================================
    - name: Check if ClamAV is installed
      command: which clamdscan
      register: clamav_check
      changed_when: false
      failed_when: false

    - name: Fail if ClamAV not installed
      fail:
        msg: |
          ClamAV is not installed on this VM.
          Please run 'make setup-vm' first to install ClamAV and its dependencies.
          If you want to deploy without ClamAV (mock mode), set av_engine=mock:
            ansible-playbook deploy.yaml -e av_engine=mock
      when: clamav_check.rc != 0 and av_engine == 'clamav'

    - name: Check if registry is running
      uri:
        url: "http://{{ registry }}/v2/"
        method: GET
        status_code: [200, 401]
      register: registry_check
      failed_when: false

    - name: Fail if registry not running
      fail:
        msg: |
          Registry is not running on this VM.
          Please run 'make setup-vm' first to install the registry.
      when: registry_check.status is not defined or registry_check.status not in [200, 401]

    # ============================================
    # Pull and Extract Binary from Registry
    # ============================================
    - name: Pull image from local registry
      command: podman pull --tls-verify=false {{ registry }}/{{ image_name }}:{{ image_tag }}
      register: podman_pull
      changed_when: "'Storing signatures' in podman_pull.stdout or 'Writing manifest' in podman_pull.stdout"

    - name: Check installed binary version
      command: /usr/local/bin/av-scanner --version
      register: installed_version
      changed_when: false
      failed_when: false

    - name: Parse installed version
      set_fact:
        installed_ver: "{{ (installed_version.stdout | default('') | regex_search('av-scanner ([^ ]+)', '\\1') | default(['none'], true))[0] }}"

    - name: Extract binary if version changed
      when: installed_ver != image_tag
      block:
        - name: Remove any existing extraction container
          command: podman rm -f av-scanner-extract
          failed_when: false
          changed_when: false

        - name: Create temporary container to extract binary
          command: podman create --name av-scanner-extract {{ registry }}/{{ image_name }}:{{ image_tag }}

        - name: Extract binary from container
          command: podman cp av-scanner-extract:/av-scanner /usr/local/bin/av-scanner
          notify: Restart av-scanner

        - name: Remove temporary container
          command: podman rm av-scanner-extract
          failed_when: false

    - name: Show version status
      debug:
        msg: "Installed: {{ installed_ver }} | Image tag: {{ image_tag }}{{ ' (skipped extraction)' if installed_ver == image_tag else ' (extracted new binary)' }}"

    - name: Set binary permissions
      file:
        path: /usr/local/bin/av-scanner
        mode: "0755"
        owner: root
        group: root

    # ============================================
    # Systemd Service Configuration
    # ============================================
    - name: Create av-scanner systemd service
      copy:
        content: |
          [Unit]
          Description=AV Scanner Service
          After=network.target clamav-daemon.service clamav-clamonacc.service

          [Service]
          Type=simple
          User=root
          Environment=PORT=3000
          Environment=AV_ENGINE={{ av_engine }}
          Environment=UPLOAD_DIR=/tmp/av-scanner
          Environment=CLAMAV_RTS_LOG_PATH=/var/log/clamav/clamonacc.log
          Environment=TM_RTS_LOG_PATH=/var/log/ds_agent/ds_agent.log
          Environment=LOG_LEVEL=info
          ExecStart=/usr/local/bin/av-scanner
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/av-scanner.service
        mode: "0644"
      notify: Restart av-scanner

    - name: Enable and start av-scanner service
      systemd:
        name: av-scanner
        state: started
        enabled: true
        daemon_reload: true

    # ============================================
    # Verification
    # ============================================
    - name: Wait for service to be ready
      uri:
        url: "http://localhost:3000/api/v1/health"
        method: GET
        status_code: [200, 503]
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display service status
      debug:
        msg: "AV Scanner is running at http://{{ ansible_host }}:3000"

  handlers:
    - name: Restart av-scanner
      systemd:
        name: av-scanner
        state: restarted
        daemon_reload: true
